<%- include('partials/header') %>

    <!-- Notifikasi untuk status upload -->
    <% if (uploadStatus === 'success') { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Berhasil!</strong> <%= count %> data inventaris baru telah berhasil ditambahkan.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } else if (uploadStatus === 'error') { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Gagal!</strong> Terjadi kesalahan saat mengunggah file. <br>
            <small>Detail: <%= message %></small>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>

    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h1 class="h2 mb-0">Daftar Barang Inventaris</h1>
        
        <!-- ======================================================= -->
        <!-- REVISI: Grup Tombol Download Diperbaiki -->
        <!-- ======================================================= -->
        <div class="d-flex flex-wrap gap-2">
            <!-- Tombol Admin -->
            <% if (user) { %>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="bi bi-cloud-upload-fill"></i> Upload Data
                </button>
                <a href="/tambah" class="btn btn-success"><i class="bi bi-plus-circle-fill"></i> Tambah Manual</a>
            <% } %>
            
            <!-- Grup Tombol Download -->
            <div class="btn-group">
                 <a href="/download-template" class="btn btn-secondary"><i class="bi bi-file-earmark-arrow-down-fill"></i> Download Template</a>
                 
                 <!-- Tombol dropdown hanya muncul jika login -->
                 <% if (user) { %>
                    <button type="button" class="btn btn-info text-white dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="visually-hidden">Toggle Dropdown</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/download-excel"><i class="bi bi-file-earmark-text-fill me-2"></i>Download Laporan Lengkap</a></li>
                        <li><a class="dropdown-item" href="/download-label"><i class="bi bi-qr-code me-2"></i>Download Laporan Label QR</a></li>
                    </ul>
                 <% } else { %>
                    <!-- Jika tidak login, tampilkan tombol Laporan Lengkap biasa -->
                    <a href="/download-excel" class="btn btn-info text-white"><i class="bi bi-file-earmark-excel-fill"></i> Download Laporan</a>
                 <% } %>
            </div>
        </div>
        <!-- ======================================================= -->
        <!-- AKHIR REVISI -->
        <!-- ======================================================= -->

    </div>

    <form action="/" method="GET" class="mb-4">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Cari berdasarkan kata kunci (nama, lokasi, kategori...)" name="search" value="<%= search %>">
            <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i> Cari</button>
            <a href="/" class="btn btn-outline-secondary">Reset</a>
        </div>
    </form>

    <div class="table-responsive bg-white p-3 rounded shadow-sm">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Nomor Inventaris</th>
                    <th>Nama Barang</th>
                    <th>Kategori</th>
                    <th>Jumlah</th>
                    <th>Kondisi</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                <% if(items.length > 0) { %>
                    <% items.forEach(item => { %>
                    <tr>
                        <td><strong><%= item.nomorInventaris %></strong></td>
                        <td><%= item.namaBarang %></td>
                        <td><span class="badge bg-secondary"><%= item.kategori %></span></td>
                        <td><%= item.jumlah %> <%= item.satuan %></td>
                        <td>
                            <% if(item.statusKondisi === 'Baik') { %>
                                <span class="badge bg-success"><%= item.statusKondisi %></span>
                            <% } else if (item.statusKondisi && item.statusKondisi.includes('Perbaikan')) { %>
                                <span class="badge bg-warning text-dark"><%= item.statusKondisi %></span>
                            <% } else { %>
                                <span class="badge bg-danger"><%= item.statusKondisi || 'N/A' %></span>
                            <% } %>
                        </td>
                        <td>
                            <a href="/barang/<%= item.id %>" class="btn btn-info btn-sm text-white" title="Lihat Detail & QR Code"><i class="bi bi-qr-code-scan"></i></a>
                               <% if (user) { %>
                                <a href="/edit/<%= item.id %>" class="btn btn-primary btn-sm" title="Edit"><i class="bi bi-pencil-square"></i></a>
                                <form action="/hapus/<%= item.id %>" method="POST" class="d-inline" onsubmit="return confirm('Yakin ingin menghapus barang ini?');">
                                    <button type="submit" class="btn btn-danger btn-sm" title="Hapus"><i class="bi bi-trash3-fill"></i></button>
                                </form>
                            <% } %>
                        </td>
                    </tr>
                    <% }) %>
                <% } else { %>
                    <tr><td colspan="6" class="text-center">Data tidak ditemukan.</td></tr>
                <% } %>
            </tbody>
        </table>
    </div>

    </div>

    <!-- Modal (Pop-up) untuk Form Upload -->
    <% if (user) { %>
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="uploadModalLabel">Upload Data Inventaris dari Excel</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form action="/upload-excel" method="POST" enctype="multipart/form-data">
            <div class="modal-body">
                <div class="mb-3">
                    <p>Silakan unggah file Excel yang sudah diisi. Sistem akan memproses dan menambahkan data secara otomatis.</p>
                    <label for="excelFile" class="form-label">Pilih File Excel (.xlsx)</label>
                    <input class="form-control" type="file" id="excelFile" name="excelFile" accept=".xlsx" required>
                </div>
                <div class="alert alert-warning small">
                    <strong>Perhatian:</strong> Pastikan data di dalam file sudah benar. Proses ini akan menambahkan semua data dalam file dan tidak bisa dibatalkan secara massal.
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
              <button type="submit" class="btn btn-primary">Upload dan Proses</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <% } %>

<%- include('partials/footer') %>